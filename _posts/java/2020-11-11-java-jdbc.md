---
layout: post
title: Java JDBC
category: java
tags: [java]
---

## Introduction

![](http://www.hauchenglee.com/assets/images/java/jdbc-introduction.png)

Ref:
- [Lesson: JDBC Basics (The Java™ Tutorials > JDBC Database Access)](Lesson: JDBC Basics (The Java™ Tutorials > JDBC Database Access)){:target="_blank"}
- [JDBC Tutorial - Tutorialspoint](https://www.tutorialspoint.com/jdbc/index.htm){:target="_blank"}

## Connection

### import JDBC Packages

```
// for standard JDBC programs
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.Statement;  

// for BigDecimal and BigInteger support
import java.math.*; 
```

### register JDBC Driver

1. `Class.forName("com.mysql.jdbc.Driver")`
   - 使用反射，后期绑定，不需要驱动程序在编译时可用
   - 大多数JDBC驱动程序类通过调用在自己的静态初始化器中注册自己`registerDriver()`
2. `DriverManager.registerDriver()`
   - Driver重複加載
   - 耦合度高

Ref:
- [java - JDBC Class.forName vs DriverManager.registerDriver - Stack Overflow](https://stackoverflow.com/questions/5484227/jdbc-class-forname-vs-drivermanager-registerdriver){:target="_blank"}
- [对JDBC驱动注册--DriverManager.registerDriver和 Class.forName()的理解-CSDN博客](https://blog.csdn.net/u013679744/article/details/56298283){:target="_blank"}

### database URL Formulation

- `getConnection(String url)`
- `getConnection(String url, Properties prop)`
- `getConnection(String url, String user, String password)`

URL:

<table>
    <thead>
        <tr>
            <th>RDBMS</th>
            <th>JDBC driver name</th>
            <th>URL format</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>MySQL</td>
            <td>com.mysql.jdbc.Driver</td>
            <td>jdbc:mysql://hostname/databaseName</td>
        </tr>
        <tr>
            <td>Oracle</td>
            <td>oracle.jdbc.driver.OracleDriver</td>
            <td>jdbc:oracle:thin:@hostname:port:databaseName</td>
        </tr>
        <tr>
            <td>SQL Server</td>
            <td>com.microsoft.sqlserver.jdbc.SQLServerDriver</td>
            <td>jdbc:sqlserver://localhost:1433;databaseName=</td>
        </tr>
    </tbody>
</table>

### create Connection Object

Example:

```
conn = DriverManager.getConnection(DB_URL,USER,PASS);

Statement stmt = conn.createStatement();
PreparedStatement pstmt = conn.preparedStatement(SQL);
CallableStatement cstmt = conn.prepareCall (SQL);
```

- PreparedStatement > createStatement:
   - 简化的SQL字符串非标准的Java对象的设置（对象类型明确性，除了使用`setObject()`，更可以明确`getter`、 `setter`类型）
   - SQL语句的预编译和数据库侧缓存可提高整体执行速度
   - 通过内置对引号和其他特殊字符的转义，自动防止SQL Injection，这要求您使用任何`PreparedStatement setXxx()`方法来设置值，因此，不要通过字符串连接来内联SQL字符串中的值。

```
//Better:
preparedStatement = connection.prepareStatement("INSERT INTO Person (name, email, birthdate, photo) VALUES (?, ?, ?, ?)");
preparedStatement.setString(1, person.getName());
preparedStatement.setString(2, person.getEmail());
preparedStatement.setTimestamp(3, new Timestamp(person.getBirthdate().getTime()));
preparedStatement.setBinaryStream(4, person.getPhoto());
preparedStatement.executeUpdate();

//Easily causes SQL Injection
preparedStatement = connection.prepareStatement("INSERT INTO Person (name, email) VALUES ('" + person.getName() + "', '" + person.getEmail() + "'");
preparedStatement.executeUpdate();
```
   
- CallableStatement: access the database **stored procedures**

Ref: [java - Difference between Statement and PreparedStatement - Stack Overflow](https://stackoverflow.com/questions/3271249/difference-between-statement-and-preparedstatement){:target="_blank"}

## Sample Code

```java
//STEP 1. Import required packages

import java.sql.*;

public class FirstExample {
    // JDBC driver name and database URL
    static final String JDBC_DRIVER = "com.mysql.jdbc.Driver";
    static final String DB_URL = "jdbc:mysql://localhost/EMP";

    //  Database credentials
    static final String USER = "username";
    static final String PASS = "password";

    public static void main(String[] args) {
        Connection conn = null;
        Statement stmt = null;
        try {
            //STEP 2: Register JDBC driver
            Class.forName("com.mysql.jdbc.Driver");

            //STEP 3: Open a connection
            conn = DriverManager.getConnection(DB_URL, USER, PASS);

            //STEP 4: Execute a query
            stmt = conn.createStatement();
            String sql;
            sql = "SELECT id, first, last, age FROM Employees";
            ResultSet rs = stmt.executeQuery(sql);

            //STEP 5: Extract data from result set
            while (rs.next()) {
                //Retrieve by column name
                int id = rs.getInt("id");
                int age = rs.getInt("age");
                String first = rs.getString("first");
                String last = rs.getString("last");
            }
            //STEP 6: Clean-up environment
            rs.close();
            stmt.close();
            conn.close();
        } catch (Exception e) {
            //Handle errors for Class.forName
            e.printStackTrace();
        } finally {
            //finally block used to close resources
            try {
                if (stmt != null)
                    stmt.close();
            } catch (SQLException se) {
                se.printStackTrace();
            }
            try {
                if (conn != null)
                    conn.close();
            } catch (SQLException se) {
                se.printStackTrace();
            }
        }
    }
}
```

## DriverManager vs DataSource

https://kknews.cc/code/9lpae5.html
https://stackoverflow.com/questions/15198319/why-do-we-use-a-datasource-instead-of-a-drivermanager

<table>
    <thead>
        <tr>
            <th></th>
            <th>DriverManager</th>
            <th>DataSource</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>Provide Connection Pool</td>
            <td>N</td>
            <td>Y</td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
        </tr>
    </tbody>
</table>

## Connection Pool

https://www.baeldung.com/java-connection-pooling


---