---
layout: post
title: Docker Image
category: it
tags: [devops]
---

## 鏡像是什麼

鏡像是一種輕量級、可執行的獨立軟件包，用來打包軟件運行環境和基於運行環境開發的軟件安，它包含運行某個軟件所需的所有內容，包括代碼、運行時、庫、環境變量和配置文件。

所有的應用，直接打包docker鏡像，就可以直接跑起來！

如何得到鏡像：
- 從遠程倉庫下載
- 朋友拷貝給你
- 自己製作一個鏡像 Dockerfile

## Docker鏡像加載原理

### UnionFS（聯合文件系統）

Union文件系統（UnionFS）是一種分層、輕量級並且高性能的文件系統，它支持對文件系統的修改作為一次提交來一層層的疊加，同時可以將不同目錄掛載到同一個虛擬文件系統下（unite serval directories into a single virtual filesystem）。 Union文件系統是Docker鏡像的基礎，鏡像可以通過分層來進行繼承，基於基礎鏡像（沒有父鏡像），可以製作各種具體的應用鏡像。

特性：一次同時加載多個文件系統，但從外面看起來，只能看到一個文件系統，聯合加載會把各層文件系統疊加起來，這樣最終的文件系統會包含所有底層的文件和目錄。

### Docker鏡像加載原理

Docker的鏡像實際上由一層一層的文件系統組成，這種層級的文件系統UnionFS。

bootfs(boot file system)主要包含bootloader & kernel, bootloader，主要是引導加載kernel。 Linux剛啟動時會加載bootfs文件系統，在Docker鏡像的最底層是bootfs。這一層與我們典型的Linux/Unix系統是一樣的，包含boot加載器和內核。當boot加載完成之後整個內核就都在內存中了，此時內存的使用權已由bootfs轉交給內核，此時系統也會卸載bootfs。

bootfs類比加載器。 （黑屏--加載--開機進入系統）

rootfs(root file system)，在bootfs之上。包含的就是典型Linux系統中的/dev, /proc, /bin, /etc等標準目錄和文件。 rootfs就是各種不同的操作系統發行版，比如Ubuntu，Centos等等。

對於一個精簡的OS，rootfs可以很小，只需要包含最基本的命令、工具和程序庫就可以了，因為底層直接用Host的Kernel，自己只需要提供rootfs就可以了。由此可見對於不同的Linux發行版，bootfs基本是一致的，rootfs會有差別，因此不同的發行版可以公用bootfs。

## 分層理解

### 分層的鏡像

我們可以去下載一個鏡像，注意觀察下載日誌的輸出，可以看到是一層一層的在下載！

思考：為什麼Docker鏡像要採用這種分層的結構呢？

最大的好處，我覺得莫過於資源共享了！比如有多個鏡像都從相同的Base鏡像構建而來，那麼宿主機只需要在磁盤上保留一份base鏡像，同時內存中也只需要加載一份base鏡像，這樣就可以為所有的容器服務了，而且鏡像的每一層都可以被共享。

查看鏡像分層的方式可以通過`docker image inspect`命令！

理解：

所有的Docker鏡像都起始於一個基礎鏡像層，當進行修改或增加新的內容時，就會在當前鏡像層之上，創建新的鏡像層。

舉一個煎蛋的例子，假如基於Ubuntu Linux 16.04創建一個新的鏡像，這就是新鏡像的第一層；如果在該鏡像中添加Python包，就會在基礎鏡像層之上創建第二個鏡像層；如果繼續添加一個安全補丁，就會創建第三個鏡像層。

在添加額外的鏡像層的同時，鏡像始終保持是當前所有鏡像的組合，理解這一點非常重要。

Docker通過存儲引擎（新版本採用快照機制）的方式來實現鏡像層堆棧，並保證多鏡像層對外展示為統一的文件系統。

Linux可用的存儲引擎有AUFS、Overlay2、Device Mapper、Btrfs以及ZFS。顧名思義，每種存儲引擎都基於Linux中對應的文件系統或者塊設備技術，並且每種存儲引擎都有其獨特的性能特點。

Docker在Windows上僅支持windowsfilter一種存儲引擎，該引擎基於NTFS文件系統之上實現了分層和CoW[1]。

### 特點

Docker鏡像都是只讀（Read only），當容器啟動時，一個新的可寫層被加載到鏡像的頂部！

這一層就是我們通常說的容器層，容器之下都叫鏡像層！

---